{% extends 'base_sources/base.html' %}
{% import 'base_sources/form-fields.html' as fields %}

{% set title_text = "Linux server management" %}

{% block page_title %}{{ title_text }}{% endblock %}

{#  CSS settings - if need #}
{# {% block html_css %}class_name{% endblock %} #}
{# {% block body_css %}class_name{% endblock %} #}
{# {% block main_css %}{% endblock %} #}
{# {% block main_div_css %}class_name{% endblock %} #}

{% block main_top %}
    {% include 'base_sources/messenger.html' %}
{% endblock %}

{% block main_content %}
                    <!-- Insert here -->
                    <div class="container content">
                        <div class="mx-auto text-center">
                            <h2>{{ title_text }}</h2>
                        </div>
                        {% if not data %}
                            <div class="row justify-content-center p-2">
                                <div class="col-8 text-center">
                                    <form method="POST" class="d-flex" id="expim-form">
                                        <div class="input-group">
                                            {% if query %}{% set value = query %}{% endif %}
                                            {{ fields.input('IP address', 'ip_address', value, "input IP plz") }}
                                            {{ fields.group_submit('<i class="fa-solid fa-magnifying-glass"></i> Get pre-check') }}
                                        </div>
                                        {{ fields.csrf() }}
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                        {% if data['get_facts'] %}
                            <div class="row justify-content-center p-2">
                                <p class="text-center"><code>{{ query }}</code></p>
                            </div>

                            {% if data['system'] or data['packages'] %}
                                <div class="row justify-content-center p-2">
                                    {% if data['system'] %}
                                    <div class="col-5">
                                        <div class="card">
                                            <div class="card-header">
                                                Summary: <i class="fa-brands fa-{{ data['system']['family']|lower }} text-danger p-1"></i> {{ data['system']['family'] }} family
                                            </div>
                                            <div class="card-body">
                                                <span class="badge bg-secondary fs-5"><i class="fa-brands fa-{{ data['system']['dist']|lower }}"></i> {{ data['system']['dist'] }} v.{{ data['system']['ver'] }}</span>
                                                <p class="card-text">{{ data['system']['kernel'] }}</p>
                                            </div>
                                            <ul class="list-group list-group-flush">
                                                {% if data['all_ipv4'] %}
                                                    <li class="list-group-item">Uses External IP:
                                                    {% for ip_adr in data['all_ipv4'] %}
                                                        <span class="badge custom-info">will be here</span>
                                                    {% endfor %}
                                                    </li>
                                                {% endif %}
                                                {% if data['all_ipv4'] %}
                                                    <li class="list-group-item">Vlan:
                                                    {% for ip_adr in data['all_ipv4'] %}
                                                        <span class="badge custom-info">will be here</span>
                                                    {% endfor %}
                                                    </li>
                                                {% endif %}
                                                <li class="list-group-item">vCPU: <strong>{{ data['system']['vCPU'] }}</strong></li>
                                                <li class="list-group-item">RAM: <strong>{{ (data['system']['RAM']|int / 1000)|round(1) }} Gb</strong></li>
                                                {% if data['mounts'] %}{% for disk in data['mounts'] %}
                                                    {% set free_percent = (disk["size_available"] / disk["size_total"]) * 100 %}{% set free_gb = disk["size_available"] / (1024 ** 3) %}
                                                    {% if disk["mount"] == "/" %}<li class="list-group-item">Disk: {% if free_percent > 45 %}<i class="fa-solid fa-circle-check text-success"></i>{% elif free_percent > 25 %}<i class="fa-solid fa-triangle-exclamation text-warning"></i>{% else %}<i class="fa-solid fa-triangle-exclamation text-danger"></i>{% endif %} Free: <strong>{{ '%.2f' % free_gb }} Gb</strong> or <strong>~{{ '%.2f' % free_percent }}%</strong></li>{% endif %}
                                                {% endfor %}{% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if data['ports'] %}
                                    <div class="col-7">
                                        <div class="card">
                                            <div class="card-header">
                                                Main Ports Listeners:
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-striped table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col" class="align-middle text-center">Services</th>
                                                            <th scope="col" class="align-middle text-center">:80</th>
                                                            <th scope="col" class="align-middle text-center">:443</th>
                                                            <th scope="col" class="align-middle text-center">:21</th>
                                                            <th scope="col" class="align-middle text-center">:3306</th>
                                                            <th scope="col" class="align-middle text-center">:8011</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for port in data['ports'] %}
                                                        {% if port["port"]|int in (80, 443, 21, 3306, 11211) %}
                                                        <tr>
                                                            <td>{{ port["name"] }}  <span class="badge rounded-pill text-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-emphasis bg-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-subtle border-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-subtle border">{% if ':' not in port['address'] %}IPv4{% else %}IPv6{% endif %}</span></td>
                                                            <td class="align-middle text-center">{% if port['port'] == 80 %}<i class="fa-solid fa-square-check text-success"></i>{% endif %}</td>
                                                            <td class="align-middle text-center">{% if port['port'] == 443 %}<i class="fa-solid fa-square-check text-success"></i>{% endif %}</td>
                                                            <td class="align-middle text-center">{% if port['port'] == 21 %}<i class="fa-solid fa-square-check text-success"></i>{% endif %}</td>
                                                            <td class="align-middle text-center">{% if port['port'] == 3306 %}<i class="fa-solid fa-square-check text-success"></i>{% endif %}</td>
                                                            <td class="align-middle text-center">{% if port['port'] == 8011 %}<i class="fa-solid fa-square-check text-success"></i>{% endif %}</td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>


                                <div class="row justify-content-center p-2">
{#                                    {% if data['system'] %}#}
{#                                    <div class="col-5">#}
{#                                        <h5>Summary:</h5>#}
{#                                        <div class="card">#}
{#                                            <div class="card-header">#}
{#                                                <i class="fa-brands fa-{{ data['system']['family']|lower }} text-danger p-1"></i> {{ data['system']['family'] }} family#}
{#                                            </div>#}
{#                                            <div class="card-body">#}
{#                                                <span class="badge bg-secondary fs-5"><i class="fa-brands fa-{{ data['system']['dist']|lower }}"></i> {{ data['system']['dist'] }} v.{{ data['system']['ver'] }}</span>#}
{#                                                <p class="card-text">{{ data['system']['kernel'] }}</p>#}
{#                                            </div>#}
{#                                            <ul class="list-group list-group-flush">#}
{#                                                {% if data['all_ipv4'] %}#}
{#                                                    <li class="list-group-item">Uses IP:#}
{#                                                    {% for ip_adr in data['all_ipv4'] %}#}
{#                                                        <span class="badge custom-info">{{ ip_adr }}</span>#}
{#                                                    {% endfor %}#}
{#                                                    </li>#}
{#                                                {% endif %}#}
{#                                                {% if data['mounts'] %}{% for disk in data['mounts'] %}#}
{#                                                    {% set free_percent = (disk["size_available"] / disk["size_total"]) * 100 %}{% set free_gb = disk["size_available"] / (1024 ** 3) %}#}
{#                                                    <li class="list-group-item{% if disk["mount"] == "/" %} list-group-item-secondary{% endif %}">Disk: {{ disk['device'] }}<p>{% if free_percent > 45 %}<i class="fa-solid fa-circle-check text-success"></i>{% elif free_percent > 25 %}<i class="fa-solid fa-triangle-exclamation text-warning"></i>{% else %}<i class="fa-solid fa-triangle-exclamation text-danger"></i>{% endif %} Free: <strong>{{ '%.2f' % free_gb }} GB</strong> or <strong>~{{ '%.2f' % free_percent }}%</strong></p></li>#}
{#                                                {% endfor %}{% endif %}#}
{#                                            </ul>#}

{#                                        # TODO переход на NutanixVM#}
{#                                            <div class="card-body">#}
{#                                                <form method="POST" action="http://tools.expim.local/">#}
{#                                                    {{  fields.csrf() }}#}
{#                                                    {{  fields.input_hidden(value=query, name='global_search_string') }}#}
{#                                                    {{  fields.input_hidden(value='search_ip', name='search_ip') }}#}
{#                                                    {{  fields.input_hidden(value='search_customer', name='search_customer') }}#}
{#                                                    {{  fields.input_hidden(value='search_url', name='search_url') }}#}
{#                                                    {{  fields.input_hidden(value='search_vms', name='search_vms') }}#}
{#                                                    {{  fields.input_hidden(value='1', name='index_form') }}#}
{##}
{#                                                    {{  fields.submit(label="More about VM", id="submit_"+query, col='8') }}#}
{#                                                </form>#}
{#                                            </div>#}

{#                                        </div>#}
{#                                    </div>#}
{#                                    {% endif %}#}
                                    {% if data['packages'] or data['ports'] %}
                                    <div class="col-12">
                                        {% if data['packages'] %}
                                            <h5>Packages:</h5>
                                            <div class="accordion pb-3" id="accordionPackages">
                                                {% for division_name in data['packages'].keys() %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ division_name }}_packages-collapseOne" aria-expanded="false" aria-controls="{{ division_name }}_packages-collapseOne">
                                                            {% if division_name == 'sys' %}
                                                                System
                                                            {% elif division_name == 'web' %}
                                                                Web services
                                                            {% elif division_name == 'db' %}
                                                                Databases
                                                            {% elif division_name == 'other' %}
                                                                Others
                                                            {% else %}
                                                                ERROR
                                                            {% endif %}
                                                        </button>
                                                    </h2>
                                                    <div id="{{ division_name }}_packages-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionPackages">
                                                        <div class="accordion-body text-start">
                                                            <form method="POST" id="expim-form">
                                                                <div class="col-12 text-center">
                                                                    <table class="table table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th scope="col" class="align-middle text-center">Package</th>
                                                                                <th scope="col" class="align-middle text-center">Version</th>
                                                                                <th scope="col" class="align-middle text-center">Status</th>
                                                                                <th scope="col" class="align-middle text-center">Update</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        {% for package in data['packages'][division_name] %}
                                                                            {% if package[2] == 'checked' %}
                                                                                {% set label = '<i class="fa-solid fa-trash-can text-danger"></i> Delete' %}
                                                                                {% set value = '-del' %}
                                                                                {% set status = '<i class="fa-solid fa-circle-check text-success"></i>' %}
                                                                            {% else %}
                                                                                {% set label = '<i class="fa-solid fa-circle-up text-success"></i> Setup' %}
                                                                                {% set value = '+set' %}
                                                                                {% set status = '<i class="fa-solid fa-minus text-secondary"></i>' %}
                                                                            {% endif %}
                                                                            <tr>
                                                                                <th scope="row"{% if package[2] %} class="table-success"{% endif %}>{{ package[0] }}</th>
                                                                                <td>{% if package[3] != None  %}{{ package[3] }}{% else %}{{ status|safe }}{% endif %}</td>
                                                                                <td>{{ status|safe }}</td>
                                                                                <td>{{ fields.checkbox(label, value, package[1]) }}</td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <div class="col-12 text-center">
                                                                    <table class="table">
                                                                        <tr>
                                                                            <td class="align-middle text-center">{{ fields.submit(label="Update state", id="division_name") }}</td>
                                                                        </tr>
                                                                    </table>
                                                                </div>
                                                                {{ fields.input_hidden(query, 'ip_address') }}
                                                                {{ fields.input_hidden('true', 'update') }}
                                                                {{ fields.csrf() }}
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        {% if data['ports'] %}
                                            <h5 class="pt-2">Ports listen:</h5>

                                            <div class="accordion pb-3" id="accordionPorts">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ports-collapseOne" aria-expanded="false" aria-controls="ports-collapseOne">
                                                            Open TCP-IP ports
                                                        </button>
                                                    </h2>
                                                    <div id="ports-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionPorts">
                                                        <div class="accordion-body text-start">

                                                            <div class="col-12 text-center">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th scope="col" class="align-middle"></th>
                                                                            <th scope="col" class="align-middle">TCP</th>
                                                                            <th scope="col" class="align-middle">Service</th>
                                                                            <th scope="col" class="align-middle">Port</th>
                                                                            <th scope="col" class="align-middle">User</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    {% for port in data['ports'] %}
                                                                        <tr>
                                                                            <td><i class="fa-solid fa-trash-can text-muted"></i></td>
                                                                            <td><span class="badge rounded-pill text-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-emphasis bg-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-subtle border-{% if ':' not in port['address'] %}success{% else %}danger{% endif %}-subtle border">{% if ':' not in port['address'] %}IPv4{% else %}IPv6{% endif %}</span></td>
                                                                            <th scope="row">{{ port["name"] }}</th>
                                                                            <td>{{ port["port"] }}</td>
                                                                            <td>{{ port["user"] }}</td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <div class="accordion" id="accordionConsoleLog">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ConsoleLog-collapseOne" aria-expanded="false" aria-controls="ConsoleLog-collapseOne">
                                            <i class="fa-solid {% if data['full_log'][0] %}fa-circle-check text-success{% else %}fa-triangle-exclamation text-danger{% endif %} px-3" aria-hidden="true"></i> Full SSH Console log
                                        </button>
                                    </h2>
                                    <div id="ConsoleLog-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionConsoleLog">
                                        <div class="accordion-body text-start">
                                            <div class="bd-callout bd-callout-{% if data['full_log'][0] %}success{% else %}warning{% endif %} text-start">
                                                <pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">{{ data['full_log'][1] }}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- //Insert here -->
{% endblock %}

{#{% block main_bottom %}<h5>bottom</h5>{% endblock %}#}

{% block custom_scripts %}{% endblock %}
